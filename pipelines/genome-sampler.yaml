resource_types:
  - name: simple-remote-directory-resource
    type: docker-image
    source:
      repository: qiime2/simple-remote-directory-resource

resources:
  - name: covid-ci
    type: git
    public: true
    source:
      uri: https://github.com/caporaso-lab/covid-ci
      branch: master

  - name: upload-gisaid
    type: simple-remote-directory-resource
    public: true
    check_every: 30m
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_upload_gisaid))
  
  - name: upload-metadata-gisaid
    type: simple-remote-directory-resource
    public: true
    check_every: 30m
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_upload_metadata_gisaid))

  - name: cleaned-metadata-gisaid
    type: simple-remote-directory-resource
    public: true
    check_every: 30m
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_cleaned_metadata_gisaid))

  - name: upload-az-tgen
    type: simple-remote-directory-resource
    public: true
    check_every: 30m
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_upload_az_tgen))

  - name: upload-az-other
    type: simple-remote-directory-resource
    public: true
    check_every: 30m
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_upload_az_other))

  - name: seqs-gisaid
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_gisaid))

  - name: seqs-az-tgen
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_az_tgen))

  - name: seqs-az-other
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_az_other))

  - name: seqs-az-focal
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_az_focal))

  - name: seqs-gisaid-matched
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_gisaid_matched))

  - name: seqs-gisaid-context
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_gisaid_context))

  - name: view-seqs-gisaid
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_view_seqs_gisaid))

  - name: selection-longitudinal
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_selection_longitudinal))

  - name: selection-diversity
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_selection_diversity))

  - name: selection-neighbors
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_selection_neighbors))

  - name: view-selections
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_view_selections))

  - name: selection-final
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_selection_final))

  - name: subsampled-gisaid-context
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_subsampled_gisaid_context))
      
  - name: seqs-final
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_final))

  - name: seqs-final-fasta
    type: simple-remote-directory-resource
    public: true
    check_every: 48h
    source:
      hostname: ((hostname))
      username: ((username))
      private_key: ((private_key))
      key_type: ((key_type))
      path: ((path_seqs_final_fasta))

jobs:
  - name: import-gisaid
    public: true
    plan:
      - get: covid-ci
      - get: upload-gisaid
        trigger: true
      - task: import-gisaid
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: import
          Q2_INPUT: input1
          Q2_FORMAT: GISAIDDNAFASTAFormat
          Q2_TYPE: FeatureData[Sequence]
          Q2_OUTPUT: ((path_seqs_gisaid))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 16384

        input_mapping:
          input1: upload-gisaid

      - put: seqs-gisaid
        params:
          source: outputs/result/

  - name: clean-metadata
    public: true
    plan:
      - get: covid-ci
      - get: upload-metadata-gisaid
        trigger: true
      - task: clean-metadata
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))
          
          SCRIPT: rename_md_col.py
          SCRIPT_I_input: input1
          SCRIPT_output: ((path_cleaned_metadata_gisaid))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:05:00
          SLURM_mem: 4096

        input_mapping:
          input1: upload-metadata-gisaid
      
      - put: cleaned-metadata-gisaid
        params:
          source: outputs/result/

  - name: match-gisaid
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid
        passed: [import-gisaid]
        trigger: true
      - get: cleaned-metadata-gisaid
        passed: [clean-metadata]
        trigger: true
      - task: match-gisaid-metadata
        file: covid-ci/tasks/execute2.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: feature_table::filter_seqs
          Q2_I_data: input1
          Q2_M_metadata: input2
          Q2_O_filtered_data: ((path_seqs_gisaid_matched))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:30:00
          SLURM_mem: 4096

        input_mapping:
          input1: seqs-gisaid
          input2: cleaned-metadata-gisaid
      - put: seqs-gisaid-matched
        params:
          source: outputs/filtered_data/

  - name: filter-gisaid
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid-matched
        passed: [match-gisaid]
        trigger: true
      - get: cleaned-metadata-gisaid
        passed: [clean-metadata]
        trigger: true
      - task: filter-gisaid
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: genome_sampler::filter_seqs
          Q2_I_sequences: input1
          Q2_P_min_length: 20000
          Q2_O_filtered_sequences: ((path_seqs_gisaid_context))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:30:00
          SLURM_mem: 4096

        input_mapping:
          input1: seqs-gisaid-matched
      - put: seqs-gisaid-context
        params:
          source: outputs/filtered_sequences/

  - name: view-gisaid
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid-context
        passed: [filter-gisaid]
        trigger: true
      - task: view-gisaid
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: feature_table::tabulate_seqs
          Q2_I_data: input1
          Q2_O_visualization: ((path_view_seqs_gisaid))

          SLURM_cpus_per_task: 1
          SLURM_time: 1:00:00
          SLURM_mem: 16384
          
        input_mapping:
          input1: seqs-gisaid-context
      - put: view-seqs-gisaid
        params:
          source: outputs/visualization/

  - name: import-az-tgen
    public: true
    plan:
      - get: covid-ci
      - get: upload-az-tgen
        trigger: true
      - task: import-az-tgen
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: import
          Q2_INPUT: input1
          Q2_FORMAT: GISAIDDNAFASTAFormat
          Q2_TYPE: FeatureData[Sequence]
          Q2_OUTPUT: ((path_seqs_az_tgen))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 4096

        input_mapping:
          input1: upload-az-tgen
      - put: seqs-az-tgen
        params:
          source: outputs/result/

  - name: import-az-other
    public: true
    plan:
      - get: covid-ci
      - get: upload-az-other
        trigger: true
      - task: import-az-other
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: import
          Q2_INPUT: input1
          Q2_FORMAT: GISAIDDNAFASTAFormat
          Q2_TYPE: FeatureData[Sequence]
          Q2_OUTPUT: ((path_seqs_az_other))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 4096

        input_mapping:
          input1: upload-az-other
      - put: seqs-az-other
        params:
          source: outputs/result/

  - name: merge-focal-seqs
    public: true
    plan:
      - get: covid-ci
      - get: seqs-az-tgen
        passed: [import-az-tgen]
        trigger: true
      - get: seqs-az-other
        passed: [import-az-other]
        trigger: true
      - task: merge-focal-seqs
        file: covid-ci/tasks/execute2.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: feature_table::merge_seqs
          Q2_I_data: input1 input2
          Q2_O_merged_data: ((path_seqs_az_focal))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 4096

        input_mapping:
          input1: seqs-az-tgen
          input2: seqs-az-other
      - put: seqs-az-focal
        params:
          source: outputs/merged_data/

  - name: sample-longitudinal
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid-context
        passed: [filter-gisaid]
        trigger: true
      - get: cleaned-metadata-gisaid
        passed: [clean-metadata]
        trigger: true
      - task: sample-longitudinal
        file: covid-ci/tasks/execute2.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: genome_sampler::sample_longitudinal
          Q2_I_context_seqs: input1
          Q2_P_start_date: 2019-12
          Q2_P_samples_per_interval: 7
          Q2_P_days_per_interval: 7
          Q2_C_dates: input2::date
          Q2_O_selection: ((path_selection_longitudinal))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 4096

        input_mapping:
          input1: seqs-gisaid-context
          input2: cleaned-metadata-gisaid
      - put: selection-longitudinal
        params:
          source: outputs/selection/

  - name: sample-diversity
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid-context
        passed: [filter-gisaid]
        trigger: true
      - task: sample-diversity
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: genome_sampler::sample_diversity
          Q2_I_context_seqs: input1
          Q2_P_percent_id: .999
          Q2_P_n_threads: 24
          Q2_O_selection: ((path_selection_diversity))

          SLURM_cpus_per_task: 24
          SLURM_time: 48:00:00
          SLURM_mem: 65536
        
        input_mapping:
          input1: seqs-gisaid-context
      - put: selection-diversity
        params:
          source: outputs/selection/

  - name: sample-neighbors
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid-context
        passed: [filter-gisaid]
        trigger: true
      - get: seqs-az-focal
        passed: [merge-focal-seqs]
        trigger: true
      - get: cleaned-metadata-gisaid
        passed: [clean-metadata]
        trigger: true
      - task: sample-neighbors
        file: covid-ci/tasks/execute3.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: genome_sampler::sample_neighbors
          Q2_I_focal_seqs: input2
          Q2_I_context_seqs: input1
          Q2_C_locale_column: input3::division
          Q2_P_percent_id: .9999
          Q2_P_samples_per_cluster: 3
          Q2_P_n_threads: 24
          Q2_O_selection: ((path_selection_neighbors))

          SLURM_cpus_per_task: 24
          SLURM_time: 24:00:00
          SLURM_mem: 65536

        input_mapping:
          input1: seqs-gisaid-context
          input2: seqs-az-focal
          input3: cleaned-metadata-gisaid
      - put: selection-neighbors
        params:
          source: outputs/selection/

  - name: summarize-selections
    public: true
    plan:
      - get: covid-ci
      - get: selection-longitudinal
        passed: [sample-longitudinal]
        trigger: true
      - get: selection-diversity
        passed: [sample-diversity]
        trigger: true
      - get: selection-neighbors
        passed: [sample-neighbors]
        trigger: true
      - task: summarize-selections
        file: covid-ci/tasks/execute3.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: genome_sampler::summarize_selections
          Q2_I_selections: input1 input2 input3
          Q2_O_visualization: ((path_view_selections))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 4096
        
        input_mapping:
          input1: selection-longitudinal
          input2: selection-diversity
          input3: selection-neighbors
      - put: view-selections
        params:
          source: outputs/visualization

  - name: combine-selections
    public: true
    plan:
      - get: covid-ci
      - get: selection-longitudinal
        passed: [sample-longitudinal]
        trigger: true
      - get: selection-diversity
        passed: [sample-diversity]
        trigger: true
      - get: selection-neighbors
        passed: [sample-neighbors]
        trigger: true
      - task: combine-selections
        file: covid-ci/tasks/execute3.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: genome_sampler::combine_selections
          Q2_I_selections: input1 input2 input3
          Q2_O_combined_selection: ((path_selection_final))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 4096

        input_mapping:
          input1: selection-longitudinal
          input2: selection-diversity
          input3: selection-neighbors
      - put: selection-final
        params:
          source: outputs/combined_selection

  - name: filter-to-subsample
    public: true
    plan:
      - get: covid-ci
      - get: seqs-gisaid-context
        passed: [filter-gisaid]
        trigger: true
      - get: selection-final
        passed: [combine-selections]
        trigger: true
      - task: filter-to-subsample
        file: covid-ci/tasks/execute2.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: feature_table::filter_seqs
          Q2_I_data: input1
          Q2_M_metadata: input2
          Q2_O_filtered_data: ((path_subsampled_gisaid_context))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 16384

        input_mapping:
          input1: seqs-gisaid-context
          input2: selection-final
      - put: subsampled-gisaid-context
        params:
          source: outputs/filtered_data/

  - name: merge-seqs
    public: true
    plan:
      - get: covid-ci
      - get: seqs-az-focal
        passed: [merge-focal-seqs]
        trigger: true
      - get: subsampled-gisaid-context
        passed: [filter-to-subsample]
        trigger: true
      - task: filter-to-subsample
        file: covid-ci/tasks/execute2.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: feature_table::merge_seqs
          Q2_I_data: input1 input2
          Q2_O_merged_data: ((path_seqs_final))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 16384

        input_mapping:
          input1: seqs-az-focal
          input2: subsampled-gisaid-context
      - put: seqs-final
        params:
          source: outputs/merged_data/

  - name: export
    public: true
    plan:
      - get: covid-ci
      - get: seqs-final
        passed: [merge-seqs]
        trigger: true
      - task: export
        file: covid-ci/tasks/execute1.yaml
        params:
          HOSTNAME: ((hostname))
          USERNAME: ((username))
          PRIVATE_KEY: ((private_key))
          KEY_TYPE: ((key_type))
          WORKDIR: ((workdir))

          Q2_ACTION: export
          Q2_INPUT: input1
          Q2_FORMAT: DNAFASTAFormat
          Q2_EXT: .fasta
          Q2_OUTPUT: ((path_seqs_final_fasta))

          SLURM_cpus_per_task: 1
          SLURM_time: 0:20:00
          SLURM_mem: 16384

        input_mapping:
          input1: seqs-final
      - put: seqs-final-fasta
        params:
          source: outputs/result/